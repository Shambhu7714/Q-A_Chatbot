<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AI PDF Assistant</title>

    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #343541;
            color: #ececf1;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #202123;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #4d4d4f;
        }

        .sidebar-header {
            padding: 12px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid #4d4d4f;
            color: #ececf1;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background: #2a2b32;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .history-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 4px;
            font-size: 14px;
            color: #ececf1;
            transition: background 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item:hover {
            background: #2a2b32;
        }

        .history-item.active {
            background: #343541;
        }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid #4d4d4f;
            font-size: 13px;
            color: #8e8ea0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #343541;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px 12px;
            scroll-behavior: smooth;
        }

        .chat-messages {
            min-height: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
            max-width: 100%;
        }

        .message-row {
            display: flex;
            padding: 8px 20px;
        }

        .message-content-wrapper {
            width: 100%;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message-row.user .message-avatar {
            background: #5436da;
        }

        .message-row.assistant .message-avatar {
            background: #10a37f;
        }

        .message-bubble {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 14px;
            background: #40414f;
            color: #ececf1;
            line-height: 1.65;
            font-size: 15px;
            word-wrap: break-word;
            white-space: normal;
            overflow-wrap: anywhere;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }

        /* Assistant bubble left */
        .message-row.assistant {
            justify-content: flex-start;
        }
        .message-row.assistant .message-content-wrapper {
            flex-direction: row;
        }
        .message-row.assistant .message-bubble {
            background: #444654;
            margin-right: auto;
        }

        /* User bubble right */
        .message-row.user {
            justify-content: flex-end;
        }
        .message-row.user .message-content-wrapper {
            flex-direction: row-reverse;
        }
        .message-row.user .message-bubble {
            background: linear-gradient(180deg, #6b4df0, #5436da);
            margin-left: auto;
            color: white;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* INPUT AREA (CHATGPT STYLE) */
        .input-area {
            padding: 18px;
            background: #343541;
            border-top: 1px solid #4d4d4f;
        }

        .input-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 14px;
            background: #40414f;
            border-radius: 12px;
            padding: 14px 18px;
            border: 1px solid #565869;
        }

        /* Upload only icon, NO "Choose File" text */
        #fileInput {
            display: none !important;
            width: 0;
            height: 0;
            opacity: 0;
            pointer-events: none;
            position: absolute;
        }

        .upload-btn {
            width: 38px;
            height: 38px;
            background: transparent;
            border: none;
            color: #ececf1;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            border-radius: 8px;
        }

        .upload-btn:hover {
            background: #565869;
        }

        /* Text area */
        #messageInput {
            flex: 1;
            border: none;
            background: transparent;
            color: #ececf1;
            font-size: 16px;
            outline: none;
            resize: none;
            padding: 4px 0;
            line-height: 1.5;
        }

        #messageInput::placeholder {
            color: #8e8ea0;
        }

        /* Send button */
        #sendBtn {
            width: 42px;
            height: 38px;
            border-radius: 8px;
            background: #10a37f;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #sendBtn:hover:not(:disabled) {
            background: #0e8c6f;
        }

        #sendBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Upload Progress Modal */
        .upload-progress-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #40414f;
            border-radius: 12px;
            padding: 30px;
            min-width: 360px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
        }

        .upload-progress-modal.show {
            display: block;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            z-index: 999;
        }

        .modal-backdrop.show {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: #565869;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: #10a37f;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>

<body>
    <div class="app-container">
        
        <!-- ================= SIDEBAR ================= -->
        <div class="sidebar" aria-hidden="false">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="newChat()">
                    <span>‚ûï</span>
                    <span>New chat</span>
                </button>
            </div>

            <div class="chat-history" id="chatHistory" role="list"></div>

            <div class="sidebar-footer">ü§ñ AI PDF Assistant</div>
        </div>

        <!-- ================= MAIN CHAT CONTENT ================= -->
        <div class="main-content" role="main">

            <!-- CHAT AREA -->
            <div class="chat-area" id="chatArea" aria-live="polite">
                <div class="chat-messages" id="chatMessages">
                    
                    <!-- EMPTY STATE -->
                    <div class="empty-state" id="emptyState">
                        <div class="empty-icon">üìÑ</div>
                        <div class="empty-title">AI PDF Assistant</div>
                        <div class="empty-text">Upload a PDF to start</div>
                    </div>

                </div>
            </div>

            <!-- INPUT BAR -->
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper" role="form" aria-label="Message input">

                        <!-- Upload icon only; actual input is hidden -->
                        <button class="upload-btn" id="uploadBtn" title="Upload PDF" aria-label="Upload PDF">üìé</button>
                        <input type="file" id="fileInput" accept=".pdf" aria-hidden="true" />

                        <!-- Message textarea -->
                        <textarea 
                            id="messageInput" 
                            placeholder="Message..." 
                            rows="1" 
                            aria-label="Message"></textarea>

                        <!-- Send button -->
                        <button id="sendBtn" title="Send message" aria-label="Send">‚¨ÜÔ∏è</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- ================= UPLOAD MODAL ================= -->
        <div class="modal-backdrop" id="modalBackdrop"></div>

        <div class="upload-progress-modal" id="uploadProgressModal" role="dialog" aria-hidden="true">
            <div class="upload-progress-title">üìÑ Uploading PDF...</div>

            <div class="progress-bar" aria-hidden="true">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="progress-text" id="progressText">Uploading...</div>
        </div>

    </div>
<script>
    let pdfId = null;
    let sessionId = null;

    /* ===========================
       MARKDOWN RENDERER
    ============================ */
    const converter = new showdown.Converter({
        noHeaderId: true,
        simplifiedAutoLink: true,
        strikethrough: true,
        tables: true,
        emoji: true,
        ghCodeBlocks: true,
        tasklists: true,
        openLinksInNewWindow: true
    });

    /* DOM ELEMENTS */
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadProgressModal = document.getElementById('uploadProgressModal');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatHistory = document.getElementById('chatHistory');
    const chatArea = document.getElementById('chatArea');
    const emptyState = document.getElementById('emptyState');

    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFileUpload(e.target.files[0]);
    });

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    /* ===========================
       FILE UPLOAD HANDLER
    ============================ */
    async function handleFileUpload(file) {

        uploadProgressModal.classList.add('show');
        modalBackdrop.classList.add('show');
        progressFill.style.width = "10%";
        progressText.textContent = "Uploading PDF...";

        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch("/upload", {
                method: "POST",
                body: formData
            });

            progressFill.style.width = "50%";
            progressText.textContent = "Extracting text...";
            await sleep(500);

            const data = await response.json();
            if (!data || !data.pdf_id) throw new Error("Upload failed.");

            progressFill.style.width = "90%";
            progressText.textContent = "Creating embeddings...";
            await sleep(500);

            progressFill.style.width = "100%";
            progressText.textContent = "Complete!";
            await sleep(400);

            pdfId = data.pdf_id;

            uploadProgressModal.classList.remove('show');
            modalBackdrop.classList.remove('show');

            chatMessages.innerHTML = "";
            addMessage("assistant", `Great! I've processed **${file.name}**.  
Feel free to ask anything about it! üìÑü§ñ`);

            addToHistory(file.name);
            messageInput.focus();

        } catch (err) {
            uploadProgressModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
            alert("Error: " + err.message);
        }

        fileInput.value = "";
    }

    /* ===========================
       SEND MESSAGE LOGIC
    ============================ */
    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    messageInput.addEventListener("input", updateSendState);
    updateSendState();

    function updateSendState() {
        sendBtn.disabled = messageInput.value.trim().length === 0;
    }

    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;

        if (!pdfId) {
            alert("Please upload a PDF first!");
            return;
        }

        if (emptyState) emptyState.remove();

        addMessage("user", text);
        messageInput.value = "";
        updateSendState();
        showTyping();

        const formData = new FormData();
        formData.append("pdf_id", pdfId);
        formData.append("question", text);
        if (sessionId) formData.append("session_id", sessionId);

        try {
            const response = await fetch("/ask", {
                method: "POST",
                body: formData
            });

            const data = await response.json();
            hideTyping();

            sessionId = data.session_id || sessionId;

            if (data.answer) {
                addMessage("assistant", data.answer);
            } else {
                addMessage("assistant", "Sorry, I couldn‚Äôt generate a response.");
            }

        } catch (err) {
            hideTyping();
            addMessage("assistant", "Error: " + err.message);
        }
    }

    /* ===========================
       ADD MESSAGE TO CHAT
       (Markdown Enabled)
    ============================ */
    function addMessage(role, text) {
        const messageRow = document.createElement("div");
        messageRow.className = `message-row ${role}`;

        const wrapper = document.createElement("div");
        wrapper.className = "message-content-wrapper";

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = role === "user" ? "üë§" : "ü§ñ";

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";

        const messageText = document.createElement("div");
        messageText.className = "message-text";

        // RENDER MARKDOWN HERE üî•
        messageText.innerHTML = converter.makeHtml(text);

        bubble.appendChild(messageText);
        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
        messageRow.appendChild(wrapper);

        const typing = document.getElementById("typingRow");
        if (typing) chatMessages.insertBefore(messageRow, typing);
        else chatMessages.appendChild(messageRow);

        chatArea.scrollTop = chatArea.scrollHeight;
    }

    /* ===========================
       TYPING INDICATOR
    ============================ */
    function showTyping() {
        hideTyping();

        const typingRow = document.createElement("div");
        typingRow.id = "typingRow";
        typingRow.className = "message-row assistant";

        const wrapper = document.createElement("div");
        wrapper.className = "message-content-wrapper";

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = "ü§ñ";

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";
        bubble.innerHTML = `
            <div class="typing-indicator">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            </div>
        `;

        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
        typingRow.appendChild(wrapper);
        chatMessages.appendChild(typingRow);

        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function hideTyping() {
        const t = document.getElementById("typingRow");
        if (t) t.remove();
    }

    /* ===========================
       CHAT HISTORY
    ============================ */
    function addToHistory(fileName) {
        document.querySelectorAll(".history-item").forEach(item => item.classList.remove("active"));

        const item = document.createElement("div");
        item.className = "history-item active";
        item.textContent = fileName;

        item.addEventListener("click", () => {
            document.querySelectorAll(".history-item").forEach(i => i.classList.remove("active"));
            item.classList.add("active");
            messageInput.focus();
        });

        chatHistory.insertBefore(item, chatHistory.firstChild);
    }

    /* ===========================
       NEW CHAT
    ============================ */
    function newChat() {
        chatMessages.innerHTML = `
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">üìÑ</div>
                <div class="empty-title">AI PDF Assistant</div>
                <div class="empty-text">Upload a PDF to start</div>
            </div>
        `;
        pdfId = null;
        sessionId = null;
        messageInput.value = "";
        updateSendState();
    }

    /* ===========================
       AUTO RESIZE TEXTAREA
    ============================ */
    messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 200) + "px";
    });
</script>
</body>
</html>
